<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦ç¿’æ—¥è¨˜ - å­¦ä¹ æ—¥è®°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    
    <style>
        :root {
            --bg-color: #F7F5F0; --card-bg: #FFFFFF; --text-main: #333333; --text-light: #8E8B82;
            --accent-color: #6B8E6B; --accent-hover: #526E52; --border-color: #E8E4D9;
            --memo-bg: #FFF9E6; --memo-border: #F2E3A9; --error-color: #D37B7B;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212; --card-bg: #1E1E1E; --text-main: #E0E0E0; --text-light: #A0A0A0;
                --accent-color: #82A882; --accent-hover: #96C296; --border-color: #333333;
                --memo-bg: #2A2820; --memo-border: #4A4630; --error-color: #E59898;
            }
        }
        body {
            font-family: 'Noto Serif JP', 'Yu Mincho', 'å®‹ä½“', serif; background-color: var(--bg-color);
            color: var(--text-main); line-height: 1.8; margin: 0; padding: 0;
            -webkit-font-smoothing: antialiased; transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 680px; margin: 0 auto; padding: 20px; padding-bottom: 120px; }
        header { text-align: center; margin: 30px 0; }
        header h1 { font-size: 26px; font-weight: 600; margin-bottom: 5px; color: var(--text-main); }
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); padding: 25px; margin-bottom: 25px; border: 1px solid var(--border-color); }
        h2 { font-size: 16px; font-weight: 600; color: var(--text-light); margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        
        textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 15px; color: var(--text-main); background: transparent; transition: all 0.3s ease; resize: vertical; }
        textarea:focus { border-color: var(--accent-color); outline: none; box-shadow: 0 0 0 2px rgba(107, 142, 107, 0.1); }
        .memo-box { background-color: var(--memo-bg); border: 1px solid var(--memo-border); border-left: 4px solid #D6C27A; margin-bottom: 20px; }
        
        .upload-area { margin-top: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        input[type="file"] { display: none; }
        .upload-btn { background: transparent; border: 1px dashed var(--accent-color); color: var(--accent-color); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .upload-btn:hover { background: rgba(107, 142, 107, 0.1); }
        
        #preview-container { display: none; position: relative; max-width: 150px; }
        #preview-img { width: 100%; border-radius: 6px; border: 1px solid var(--border-color); }
        .remove-img { position: absolute; top: -8px; right: -8px; background: var(--error-color); color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 18px; cursor: pointer; font-size: 12px; font-weight: bold; }
        
        .btn-submit { background: var(--accent-color); color: #fff; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 15px; width: 100%; transition: background 0.2s; }
        .btn-submit:hover { background: var(--accent-hover); }
        .btn-delete { background: transparent; border: 1px solid var(--error-color); color: var(--error-color); padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .btn-delete:hover { background: var(--error-color); color: #fff; }
        
        .entry-item { padding: 20px 0; border-bottom: 1px solid var(--border-color); }
        .entry-item:last-child { border-bottom: none; }
        .entry-date { font-size: 13px; color: var(--text-light); }
        .entry-memo { background: var(--memo-bg); padding: 10px 15px; border-radius: 4px; font-size: 14px; margin-bottom: 15px; border-left: 3px solid #D6C27A; white-space: pre-wrap; color: var(--text-main); }
        .entry-text { white-space: pre-wrap; font-size: 15px; margin-bottom: 10px; }
        .entry-image { max-width: 100%; border-radius: 8px; margin-top: 10px; }
        
        #auth-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-color); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: var(--card-bg); padding: 30px; border-radius: 12px; text-align: center; border: 1px solid var(--border-color); }
        .auth-card input { padding: 10px; width: 100%; margin: 15px 0; border: 1px solid var(--border-color); border-radius: 6px; text-align: center; font-size: 16px; background: transparent; color: var(--text-main); }
        .auth-card button { background: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%; }
        .msg { text-align: center; margin-top: 10px; font-size: 13px; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-card">
            <h2 style="border:none; margin:0; font-size: 18px;">ç©ºé–“èªè¨¼</h2>
            <input type="password" id="loginPwd" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ">
            <button onclick="verifyPassword()">å…¥å®¤ã™ã‚‹ (Enter)</button>
            <div id="login-msg" class="msg" style="color: var(--error-color);"></div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>å­¦ç¿’æ—¥è¨˜</h1>
        </header>

        <div class="card">
            <h2>ğŸ“ æ–°çš„ä¸€å¤©</h2>
            <textarea id="memoInput" class="memo-box" rows="2" placeholder="ğŸ“Œ ä¾¿ç­¾ / å¤‡å¿˜å½• (ä¾‹å¦‚: ä»Šæ™šè®°å¾—å¤ä¹ åŠ¨è¯å˜å½¢...)"></textarea>
            <textarea id="diaryInput" rows="6" placeholder="ä»Šå¤©å­¦ä¹ äº†ä»€ä¹ˆï¼Ÿè®°å½•ä¸€ä¸‹å§..."></textarea>
            
            <div class="upload-area">
                <label for="imageUpload" class="upload-btn">ğŸ“· æ·»åŠ å›¾ç‰‡</label>
                <input type="file" id="imageUpload" accept="image/*" onchange="handleImageSelect(event)">
                <div id="preview-container">
                    <span class="remove-img" onclick="removeImage()">Ã—</span>
                    <img id="preview-img" src="">
                </div>
            </div>

            <button class="btn-submit" onclick="saveEntry()">ä¿å­˜è¨˜éŒ² (Save)</button>
            <div id="save-msg" class="msg"></div>
        </div>

        <div class="card">
            <h2>ğŸ“š å†å²è®°å½•</h2>
            <div id="entries-list">
                <p style="text-align: center; color: var(--text-light);">åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <script src="https://fastly.jsdelivr.net/gh/WeiErLiTeo/live2d-widget@latest/autoload.js"></script>

    <script>
        // ==========================================
        // æ—¥è®°ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘
        // ==========================================
        const API_BASE = '/api/diary';
        let currentPwd = localStorage.getItem('site_pwd') || '';
        let currentImageBase64 = null;

        window.onload = () => {
            if (currentPwd) loadEntries(true); 
        };

        async function verifyPassword() {
            const pwdInput = document.getElementById('loginPwd').value;
            const msgEl = document.getElementById('login-msg');
            if (!pwdInput) return;
            msgEl.textContent = 'éªŒè¯ä¸­...'; msgEl.style.color = 'var(--text-light)';
            try {
                const res = await fetch(API_BASE, { headers: { 'Authorization': pwdInput } });
                if (res.ok) {
                    currentPwd = pwdInput; localStorage.setItem('site_pwd', currentPwd);
                    document.getElementById('auth-overlay').style.display = 'none';
                    loadEntries(false);
                } else {
                    msgEl.textContent = 'å¯†ç é”™è¯¯'; msgEl.style.color = 'var(--error-color)';
                }
            } catch (err) {
                msgEl.textContent = 'ç½‘ç»œé”™è¯¯'; msgEl.style.color = 'var(--error-color)';
            }
        }

        function handleImageSelect(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height; const MAX_WIDTH = 1000;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    currentImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('preview-img').src = currentImageBase64;
                    document.getElementById('preview-container').style.display = 'block';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            currentImageBase64 = null; document.getElementById('imageUpload').value = '';
            document.getElementById('preview-container').style.display = 'none';
        }

        async function saveEntry() {
            const memo = document.getElementById('memoInput').value.trim();
            const diary = document.getElementById('diaryInput').value.trim();
            const msgEl = document.getElementById('save-msg');

            if (!memo && !diary && !currentImageBase64) {
                msgEl.textContent = 'è¯·å¡«å†™å†…å®¹æˆ–ä¸Šä¼ å›¾ç‰‡'; msgEl.style.color = 'var(--error-color)'; return;
            }
            msgEl.textContent = 'ä¿å­˜ä¸­...'; msgEl.style.color = 'var(--text-light)';
            const payload = { memo, diary, image: currentImageBase64 };

            try {
                const res = await fetch(API_BASE, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': currentPwd },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    msgEl.textContent = 'ä¿å­˜æˆåŠŸ'; msgEl.style.color = 'var(--accent-color)';
                    document.getElementById('memoInput').value = ''; document.getElementById('diaryInput').value = '';
                    removeImage(); loadEntries(false);
                    setTimeout(() => msgEl.textContent = '', 2000);
                } else {
                    msgEl.textContent = 'ä¿å­˜å¤±è´¥'; msgEl.style.color = 'var(--error-color)';
                }
            } catch (err) {
                msgEl.textContent = 'ç½‘ç»œé”™è¯¯'; msgEl.style.color = 'var(--error-color)';
            }
        }

        async function loadEntries(isInit = false) {
            const listEl = document.getElementById('entries-list');
            try {
                const res = await fetch(API_BASE, { headers: { 'Authorization': currentPwd } });
                if (res.ok) {
                    if (isInit) document.getElementById('auth-overlay').style.display = 'none';
                    const data = await res.json(); renderEntries(data.entries);
                } else {
                    if (isInit) localStorage.removeItem('site_pwd');
                    else listEl.innerHTML = '<p style="color:var(--error-color)">è¯»å–å¤±è´¥</p>';
                }
            } catch (err) {
                if (!isInit) listEl.innerHTML = '<p style="color:var(--error-color)">ç½‘ç»œè¿æ¥å¤±è´¥</p>';
            }
        }

        async function deleteEntry(id) {
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ")) return;
            try {
                const res = await fetch(`${API_BASE}?id=${id}`, {
                    method: 'DELETE', headers: { 'Authorization': currentPwd }
                });
                if (res.ok) loadEntries(false);
                else alert('åˆ é™¤å¤±è´¥');
            } catch (err) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        function renderEntries(entries) {
            const listEl = document.getElementById('entries-list');
            listEl.innerHTML = '';
            if (!entries || entries.length === 0) { listEl.innerHTML = '<p style="text-align: center; color: var(--text-light);">æš‚æ— è®°å½•</p>'; return; }

            entries.forEach(item => {
                const div = document.createElement('div'); div.className = 'entry-item';
                const date = new Date(item.timestamp);
                const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
                
                let html = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div class="entry-date">${dateStr}</div>
                        <button class="btn-delete" onclick="deleteEntry('${item.id}')">å‰Šé™¤</button>
                    </div>
                `;
                if (item.data.memo) html += `<div class="entry-memo">ğŸ“Œ ${escapeHtml(item.data.memo)}</div>`;
                if (item.data.diary) html += `<div class="entry-text">${escapeHtml(item.data.diary)}</div>`;
                if (item.data.image) html += `<img class="entry-image" src="${item.data.image}">`;

                div.innerHTML = html; listEl.appendChild(div);
            });
        }

        function escapeHtml(unsafe) {
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
