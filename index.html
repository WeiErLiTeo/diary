<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥æœ¬èªã®æ—¥è¨˜</title>
    <!-- å¼•å…¥ä¼˜é›…çš„æ—¥æ–‡å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* æŠ¤çœ¼å’Œé£è‰²å½© (Wabi-Sabi Colors) */
            --bg-color: #F7F5F0;       /* å’Œçº¸åº•è‰² */
            --card-bg: #FFFFFF;        /* å¡ç‰‡çº¯ç™½ */
            --text-main: #4A4A4A;      /* å¢¨é»‘ï¼ˆæŸ”å’Œçš„é»‘è‰²ï¼‰ */
            --text-light: #8E8B82;     /* æµ…å¢¨è‰² */
            --accent-green: #7B8D76;   /* åƒè‰è‰²/æŠ¹èŒ¶ç»¿ */
            --accent-hover: #63755E;   /* æ·±æŠ¹èŒ¶ */
            --border-color: #E8E4D9;   /* ææµ…çš„è¾¹æ¡†è‰² */
            --danger-color: #D37B7B;   /* é€€çº¢è‰²ï¼ˆæŠ¥é”™ï¼‰ */
        }

        body {
            font-family: 'Noto Serif JP', 'Yu Mincho', 'å®‹ä½“', serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.8;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin: 40px 0;
        }

        header h1 {
            font-size: 28px;
            font-weight: 600;
            letter-spacing: 2px;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        header p {
            font-size: 14px;
            color: var(--text-light);
            margin: 0;
        }

        /* ç°ä»£åœ†è§’å¡ç‰‡ */
        .paper-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.03);
            padding: 30px;
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.3s ease;
        }

        h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-green);
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        h2::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 18px;
            background-color: var(--accent-green);
            margin-right: 10px;
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        /* ç°ä»£è¾“å…¥æ¡†é£æ ¼ */
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-sizing: border-box;
            font-family: inherit;
            background-color: #FCFAf8;
            font-size: 15px;
            color: var(--text-main);
            transition: all 0.3s ease;
            resize: vertical;
        }

        input:focus, textarea:focus {
            border-color: var(--accent-green);
            outline: none;
            box-shadow: 0 0 0 4px rgba(123, 141, 118, 0.1);
            background-color: #fff;
        }

        /* æŒ‰é’®è®¾è®¡ */
        .btn {
            background: var(--accent-green);
            color: #fff;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            width: 100%;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(123, 141, 118, 0.2);
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(123, 141, 118, 0.3);
        }

        .btn:active {
            transform: translateY(1px);
        }

        /* çŠ¶æ€æç¤º */
        .status-msg {
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
            min-height: 20px;
        }
        .status-error { color: var(--danger-color); }
        .status-success { color: var(--accent-green); }

        /* æ—¥è®°è®°å½•å±•ç¤ºåŒº */
        .entry-item {
            padding: 24px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .entry-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .entry-date {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .entry-content {
            white-space: pre-wrap;
            font-size: 16px;
            margin-bottom: 15px;
        }

        /* å•è¯å’Œè¯­æ³•ç‰¹åˆ«æ ‡è¯† */
        .entry-badge {
            background: #F4F1EA;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 10px;
            color: var(--text-main);
            white-space: pre-wrap;
        }
        .badge-title {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
            display: block;
        }

        /* å…¨å±å¯†ç è®¤è¯é®ç½©å±‚ */
        #auth-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-color);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.4s ease;
        }
        .auth-card {
            background: var(--card-bg);
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 360px;
            text-align: center;
        }
        .auth-card h2::before { display: none; }
        .auth-card h2 { justify-content: center; margin-bottom: 30px; font-size: 22px; color: var(--text-main); }

        /* æ‰‹æœºç«¯é€‚é…è°ƒæ•´ */
        @media (max-width: 480px) {
            .paper-card { padding: 20px; }
            .container { padding: 15px; }
        }
    </style>
</head>
<body>

    <!-- å¯†ç éªŒè¯é®ç½© -->
    <div id="auth-overlay">
        <div class="auth-card">
            <h2>èªè¨¼ (Authentication)</h2>
            <p style="color: var(--text-light); font-size: 13px; margin-bottom: 20px;">è¯·è¾“å…¥ç©ºé—´è®¿é—®å¯†ç </p>
            <input type="password" id="loginPwd" placeholder="Password" style="margin-bottom: 20px; text-align: center;">
            <button class="btn" onclick="verifyPassword()">å…¥å®¤ã™ã‚‹ (Enter)</button>
            <div id="login-msg" class="status-msg status-error"></div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>æ—¥æœ¬èªã®æ—¥è¨˜</h1>
            <p>é™ã‹ãªã‚‹å­¦ã³ã®è¨˜éŒ²</p>
        </header>

        <!-- ç¼–è¾‘åŒº -->
        <div class="paper-card">
            <h2>æ–°ã—ã„è¨˜éŒ² (æ–°è®°å½•)</h2>
            <div class="form-group">
                <label>å˜èª (ç”Ÿè¯)</label>
                <textarea id="vocab" rows="2" placeholder="ä¾‹å¦‚ï¼šæ¡œï¼ˆã•ãã‚‰ï¼‰- æ¨±èŠ±"></textarea>
            </div>
            <div class="form-group">
                <label>æ–‡æ³• (è¯­æ³•)</label>
                <textarea id="grammar" rows="2" placeholder="ä¾‹å¦‚ï¼šï½ã‚ˆã†ã«ãªã‚‹ - å˜å¾—..."></textarea>
            </div>
            <div class="form-group">
                <label>æœ¬æ–‡ (æ—¥è®°æ­£æ–‡)</label>
                <textarea id="diary" rows="5" placeholder="ä»Šæ—¥ã¯ä½•ã‚’ã—ã¾ã—ãŸã‹ï¼Ÿ"></textarea>
            </div>
            <button class="btn" onclick="saveEntry()">ä¿å­˜ã™ã‚‹ (ä¿å­˜)</button>
            <div id="save-msg" class="status-msg"></div>
        </div>

        <!-- å†å²è®°å½•åŒº -->
        <div class="paper-card" style="margin-top: 40px;">
            <h2>éå»ã®è¨˜éŒ² (å†å²è®°å½•)</h2>
            <div id="entries-list">
                <p style="color: var(--text-light); text-align: center; font-size: 14px;">èª­ã¿è¾¼ã¿ä¸­... (åŠ è½½ä¸­)</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/diary'; // ç›¸å¯¹è·¯å¾„ï¼Œå› ä¸ºéƒ¨ç½²åœ¨åŒä¸€ä¸ª Pages é¡¹ç›®ä¸‹
        let currentPwd = localStorage.getItem('site_pwd') || '';

        // åˆå§‹åŒ–æ£€æŸ¥å¯†ç 
        window.onload = () => {
            if (currentPwd) {
                // å¦‚æœæœ‰æœ¬åœ°å¯†ç ï¼Œå°è¯•åŠ è½½æ•°æ®æµ‹è¯•å¯†ç æ˜¯å¦æ­£ç¡®
                loadEntries(true);
            }
        };

        // éªŒè¯å¯†ç ç™»å½•
        async function verifyPassword() {
            const pwdInput = document.getElementById('loginPwd').value;
            const msgEl = document.getElementById('login-msg');
            if (!pwdInput) { msgEl.textContent = 'å¯†ç ä¸èƒ½ä¸ºç©º'; return; }
            
            msgEl.textContent = 'éªŒè¯ä¸­...';
            msgEl.className = 'status-msg status-success';

            try {
                // å‘é€æµ‹è¯•è¯·æ±‚
                const res = await fetch(API_BASE, {
                    headers: { 'Authorization': pwdInput }
                });
                
                if (res.ok) {
                    // å¯†ç æ­£ç¡®
                    currentPwd = pwdInput;
                    localStorage.setItem('site_pwd', currentPwd);
                    document.getElementById('auth-overlay').style.opacity = '0';
                    setTimeout(() => document.getElementById('auth-overlay').style.display = 'none', 400);
                    loadEntries(false); // åŠ è½½åˆ—è¡¨
                } else {
                    msgEl.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ (å¯†ç é”™è¯¯)';
                    msgEl.className = 'status-msg status-error';
                }
            } catch (err) {
                msgEl.textContent = 'ç½‘ç»œé”™è¯¯';
                msgEl.className = 'status-msg status-error';
            }
        }

        // ä¿å­˜æ—¥è®°
        async function saveEntry() {
            const vocab = document.getElementById('vocab').value.trim();
            const grammar = document.getElementById('grammar').value.trim();
            const diary = document.getElementById('diary').value.trim();
            const msgEl = document.getElementById('save-msg');

            if (!vocab && !grammar && !diary) {
                msgEl.textContent = 'è¯·è‡³å°‘å¡«å†™ä¸€é¡¹å†…å®¹ã€‚';
                msgEl.className = 'status-msg status-error';
                return;
            }

            msgEl.textContent = 'ä¿å­˜ä¸­...';
            msgEl.className = 'status-msg status-success';

            const payload = { vocab, grammar, diary };

            try {
                const res = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': currentPwd
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    msgEl.textContent = 'ä¿å­˜æˆåŠŸï¼';
                    document.getElementById('vocab').value = '';
                    document.getElementById('grammar').value = '';
                    document.getElementById('diary').value = '';
                    loadEntries(false);
                    setTimeout(() => msgEl.textContent = '', 3000);
                } else {
                    msgEl.textContent = 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç ã€‚';
                    msgEl.className = 'status-msg status-error';
                }
            } catch (err) {
                msgEl.textContent = 'ç½‘ç»œé”™è¯¯: ' + err.message;
                msgEl.className = 'status-msg status-error';
            }
        }

        // åŠ è½½æ—¥è®°åˆ—è¡¨
        async function loadEntries(isInitialCheck = false) {
            const listEl = document.getElementById('entries-list');
            
            try {
                const res = await fetch(API_BASE, {
                    headers: { 'Authorization': currentPwd }
                });

                if (res.ok) {
                    if (isInitialCheck) {
                        document.getElementById('auth-overlay').style.display = 'none';
                    }
                    const data = await res.json();
                    renderEntries(data.entries);
                } else {
                    if (isInitialCheck) {
                        // åˆå§‹æ£€æŸ¥å¤±è´¥ï¼Œè¯´æ˜æœ¬åœ°å¯†ç å·²å¤±æ•ˆï¼Œæ˜¾ç¤ºç™»å½•æ¡†
                        localStorage.removeItem('site_pwd');
                    } else {
                        listEl.innerHTML = '<p class="status-error">è¯»å–å¤±è´¥ï¼Œè®¤è¯æ— æ•ˆã€‚</p>';
                    }
                }
            } catch (err) {
                if (!isInitialCheck) {
                    listEl.innerHTML = '<p class="status-error">ç½‘ç»œè¿æ¥å¤±è´¥ã€‚</p>';
                }
            }
        }

        // æ¸²æŸ“æ—¥è®°åˆ—è¡¨
        function renderEntries(entries) {
            const listEl = document.getElementById('entries-list');
            listEl.innerHTML = '';

            if (!entries || entries.length === 0) {
                listEl.innerHTML = '<p style="color: var(--text-light); text-align: center;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            entries.forEach(item => {
                const div = document.createElement('div');
                div.className = 'entry-item';
                
                const date = new Date(item.timestamp);
                const dateStr = `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥`;
                const timeStr = `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
                
                let html = `<div class="entry-date"><span>${dateStr}</span><span>${timeStr}</span></div>`;

                if (item.data.diary) {
                    html += `<div class="entry-content">${escapeHtml(item.data.diary)}</div>`;
                }
                if (item.data.vocab) {
                    html += `<div class="entry-badge"><span class="badge-title">ğŸ“Œ å•è¯</span>${escapeHtml(item.data.vocab)}</div>`;
                }
                if (item.data.grammar) {
                    html += `<div class="entry-badge"><span class="badge-title">ğŸ“– è¯­æ³•</span>${escapeHtml(item.data.grammar)}</div>`;
                }

                div.innerHTML = html;
                listEl.appendChild(div);
            });
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
